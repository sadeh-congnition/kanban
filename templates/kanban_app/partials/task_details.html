<div class="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="modal-content" style="max-width: 600px;">
        <form id="task-details-form" hx-post="/api/tasks/{{ task.id }}/update_details" hx-swap="none"></form>

        <div class="modal-header" style="align-items: flex-start;">
            <div style="flex: 1; margin-right: 1rem;">
                <input form="task-details-form" type="text" name="title" value="{{ task.title }}"
                    style="font-size: 1.5rem; font-weight: bold; color: white; border: 1px solid transparent; background: transparent; padding: 0.25rem 0.5rem; border-radius: 0.375rem; width: 100%; transition: all 0.2s;"
                    onfocus="this.style.border='1px solid #d4d4d8'; this.style.backgroundColor='#ffffff'; this.style.color='#18181b';"
                    onblur="this.style.border='1px solid transparent'; this.style.backgroundColor='transparent'; this.style.color='white';"
                    oninput="document.getElementById('save-details-btn').style.display='block';" required>
            </div>
            <button class="btn btn-ghost" onclick="closeModal()">&times;</button>
        </div>

        <div style="margin-bottom: 1.5rem; padding-left: 0.5rem;">
            <p style="color: #52525b; font-size: 0.9rem; margin-top: 0;">#{{ task.project_task_id|default:task.id }} in
                <strong>{{ task.column.name }}</strong>
            </p>
        </div>

        <div style="display: flex; gap: 2rem; flex-wrap: wrap; padding-left: 0.5rem;">

            <div style="flex: 2; min-width: 300px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3 style="font-size: 1rem; margin: 0; color: #3f3f46;">Description</h3>
                    <button type="submit" form="task-details-form" id="save-details-btn" class="btn btn-sm btn-primary"
                        style="display: none;">Save Details</button>
                </div>
                <textarea form="task-details-form" name="description"
                    style="width: 100%; min-height: 12rem; padding: 1rem; border-radius: 0.5rem; background-color: #3f3f46; color: white; border: 1px solid transparent; font-size: 0.95rem; font-family: inherit; resize: vertical; transition: border-color 0.2s;"
                    onfocus="this.style.borderColor='#a1a1aa';" onblur="this.style.borderColor='transparent';"
                    oninput="document.getElementById('save-details-btn').style.display='block';"
                    placeholder="Add a more detailed description...">{{ task.description|default:"" }}</textarea>
            </div>

            <div style="flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 1.5rem;">

                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: #3f3f46;">Assignee</h3>
                    <form hx-post="/api/tasks/{{ task.id }}/assign" hx-swap="none">
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                            <select name="user_id" class="form-control" style="flex: 1;"
                                onchange="this.form.querySelector('#save-assignment-btn').style.display = 'block';">
                                <option value="" {% if not task.assigned_to_id %}selected{% endif %}>Unassigned</option>
                                {% for u in users %}
                                {% if task.assigned_to_id == u.id %}
                                <option value="{{ u.id }}" selected>{{ u.username }}</option>
                                {% else %}
                                <option value="{{ u.id }}">{{ u.username }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            {% if task.assigned_to_id != request.user.id %}
                            <button type="submit" name="user_id" value="{{ request.user.id }}"
                                class="btn btn-sm btn-ghost" title="Assign to me">
                                Assign to me
                            </button>
                            {% endif %}
                        </div>
                        <button type="submit" id="save-assignment-btn" class="btn btn-sm btn-primary"
                            style="display: none; width: 100%;">Save
                            Assignment</button>
                    </form>
                </div>

                <div>
                    <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: #3f3f46;">Tags</h3>
                    <form hx-post="/api/tasks/{{ task.id }}/tags" hx-swap="none">
                        {% if tags %}
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                            {% for tag in tags %}
                            <label
                                style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.9rem; cursor: pointer; padding: 0.25rem 0.5rem; border: 1px solid #e4e4e7; border-radius: 0.375rem; user-select: none;">
                                <input type="checkbox" name="tags" value="{{ tag.id }}"
                                    onchange="this.form.querySelector('button').style.display = 'block';">
                                <span
                                    style="background-color: {{ tag.color }}; color: white; padding: 0.1rem 0.5rem; border-radius: 999px; font-size: 0.75rem;">
                                    {{ tag.name }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary" style="display: none; width: 100%;">Save
                            Tags</button>
                        {% else %}
                        <p style="color: #71717a; font-size: 0.875rem;">No tags available.</p>
                        {% endif %}
                    </form>
                </div>

            </div>
        </div>

        {% if history %}
        <div style="margin-top: 2rem; padding-left: 0.5rem;">
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: #3f3f46;">Change History</h3>
            <div
                style="display: flex; flex-direction: column; gap: 0; border-left: 2px solid #3f3f46; padding-left: 1rem;">
                {% for event in history %}
                <div style="position: relative; padding: 0.5rem 0 0.5rem 0.25rem;">
                    {% if event.type == 'status' %}
                    <div
                        style="position: absolute; left: -1.4rem; top: 0.85rem; width: 0.65rem; height: 0.65rem; border-radius: 50%; background-color: #6366f1; border: 2px solid #27272a;">
                    </div>
                    {% else %}
                    <div
                        style="position: absolute; left: -1.4rem; top: 0.85rem; width: 0.65rem; height: 0.65rem; border-radius: 50%; background-color: #10b981; border: 2px solid #27272a;">
                    </div>
                    {% endif %}
                    <p style="margin: 0; font-size: 0.8rem; color: #71717a;">{{ event.changed_at|date:"M j, Y H:i" }}
                    </p>
                    {% if event.type == 'status' %}
                    <p style="margin: 0.15rem 0 0; font-size: 0.875rem; color: #d4d4d8;">
                        {% if event.old_column %}
                        Moved from <strong style="color: white;">{{ event.old_column.name }}</strong> to <strong
                            style="color: white;">{{ event.new_column.name }}</strong>
                        {% else %}
                        Created in <strong style="color: white;">{{ event.new_column.name }}</strong>
                        {% endif %}
                    </p>
                    {% elif event.type == 'assignment' %}
                    <p style="margin: 0.15rem 0 0; font-size: 0.875rem; color: #d4d4d8;">
                        {% if event.new_assignee and event.old_assignee %}
                        Reassigned from <strong style="color: white;">{{ event.old_assignee.username }}</strong> to
                        <strong style="color: white;">{{ event.new_assignee.username }}</strong>
                        {% elif event.new_assignee %}
                        Assigned to <strong style="color: white;">{{ event.new_assignee.username }}</strong>
                        {% else %}
                        Unassigned from <strong style="color: white;">{{ event.old_assignee.username }}</strong>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>